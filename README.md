# Block Nested Loops Join Implementation

TPC-H PARTì™€ PARTSUPP í…Œì´ë¸”ì— ëŒ€í•œ Block Nested Loops Join êµ¬í˜„

## í”„ë¡œì íŠ¸ ê°œìš”

ì´ í”„ë¡œì íŠ¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œì˜ í•µì‹¬ ì—°ì‚°ì¸ Joinì„ Block Nested Loops ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ êµ¬í˜„í•œ ê²ƒì…ë‹ˆë‹¤. C++ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©°, ê³ ì • í¬ê¸° ë¸”ë¡ì— ê°€ë³€ ê¸¸ì´ ë ˆì½”ë“œë¥¼ ì €ì¥í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

## ì£¼ìš” ê¸°ëŠ¥

- âœ… **ê³ ì • í¬ê¸° ë¸”ë¡ ê´€ë¦¬**: 4KB ê¸°ë³¸ ë¸”ë¡ í¬ê¸° (ì¡°ì ˆ ê°€ëŠ¥)
- âœ… **ê°€ë³€ ê¸¸ì´ ë ˆì½”ë“œ ì§€ì›**: íš¨ìœ¨ì ì¸ ì§ë ¬í™”/ì—­ì§ë ¬í™”
- âœ… **Block Nested Loops Join**: ì „í†µì ì¸ ì¡°ì¸ ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
- âœ… **ë²„í¼ ê´€ë¦¬**: ì„¤ì • ê°€ëŠ¥í•œ ë²„í¼ í¬ê¸°ë¡œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± ì¡°ì ˆ
- âœ… **ì„±ëŠ¥ ì¸¡ì •**: ìˆ˜í–‰ ì‹œê°„, I/O íšŸìˆ˜, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¸¡ì •
- âœ… **TPC-H í˜¸í™˜**: PARTì™€ PARTSUPP í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì§€ì›

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application Layer                  â”‚
â”‚         (main.cpp - CLI Interface)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Join Execution Layer                 â”‚
â”‚    (BlockNestedLoopsJoin - join.cpp)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Buffer Managerâ”‚          â”‚ Table I/O      â”‚
â”‚ (buffer.cpp)  â”‚          â”‚ (table.cpp)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚
        â”‚                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Block & Record Management            â”‚
â”‚   (block.cpp, record.cpp)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Disk Storage                       â”‚
â”‚        (Block-based Binary Files)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
DBSys/
â”œâ”€â”€ include/              # í—¤ë” íŒŒì¼
â”‚   â”œâ”€â”€ common.h         # ê³µí†µ íƒ€ì… ë° ìƒìˆ˜ ì •ì˜
â”‚   â”œâ”€â”€ block.h          # ë¸”ë¡ ê´€ë¦¬
â”‚   â”œâ”€â”€ record.h         # ë ˆì½”ë“œ ì§ë ¬í™”/ì—­ì§ë ¬í™”
â”‚   â”œâ”€â”€ table.h          # í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ë° I/O
â”‚   â”œâ”€â”€ buffer.h         # ë²„í¼ ê´€ë¦¬
â”‚   â””â”€â”€ join.h           # Join ì•Œê³ ë¦¬ì¦˜
â”œâ”€â”€ src/                 # êµ¬í˜„ íŒŒì¼
â”‚   â”œâ”€â”€ block.cpp
â”‚   â”œâ”€â”€ record.cpp
â”‚   â”œâ”€â”€ table.cpp
â”‚   â”œâ”€â”€ buffer.cpp
â”‚   â”œâ”€â”€ join.cpp
â”‚   â””â”€â”€ main.cpp
â”œâ”€â”€ data/                # ë°ì´í„° íŒŒì¼ (.tbl, .dat)
â”œâ”€â”€ output/              # ê²°ê³¼ íŒŒì¼
â”œâ”€â”€ scripts/             # ìœ í‹¸ë¦¬í‹° ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ Makefile            # ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ README.md           # ì´ ë¬¸ì„œ
```

## ë¹Œë“œ ë°©ë²•

### ìš”êµ¬ì‚¬í•­
- C++11 ì´ìƒ ì§€ì› ì»´íŒŒì¼ëŸ¬ (g++, clang++)
- Make

### ì»´íŒŒì¼
```bash
make                # ìµœì í™” ë¹Œë“œ
make debug          # ë””ë²„ê·¸ ë¹Œë“œ
make clean          # ë¹Œë“œ íŒŒì¼ ì‚­ì œ
```

## ì‚¬ìš© ë°©ë²•

### 1. CSV íŒŒì¼ì„ ë¸”ë¡ í˜•ì‹ìœ¼ë¡œ ë³€í™˜

TPC-H ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ê¸° ì „ì— CSV(ë˜ëŠ” .tbl) íŒŒì¼ì„ ë¸”ë¡ ê¸°ë°˜ ë°”ì´ë„ˆë¦¬ íŒŒì¼ë¡œ ë³€í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
# PART í…Œì´ë¸” ë³€í™˜
./dbsys --convert-csv \
  --csv-file data/part.tbl \
  --block-file data/part.dat \
  --table-type PART \
  --block-size 4096

# PARTSUPP í…Œì´ë¸” ë³€í™˜
./dbsys --convert-csv \
  --csv-file data/partsupp.tbl \
  --block-file data/partsupp.dat \
  --table-type PARTSUPP \
  --block-size 4096
```

### 2. Block Nested Loops Join ì‹¤í–‰

```bash
./dbsys --join \
  --outer-table data/part.dat \
  --inner-table data/partsupp.dat \
  --outer-type PART \
  --inner-type PARTSUPP \
  --output output/result.dat \
  --buffer-size 10 \
  --block-size 4096
```

### 3. ë‹¤ì–‘í•œ ë²„í¼ í¬ê¸°ë¡œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

```bash
# ìë™ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
make test

# ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ ë‹¤ì–‘í•œ ë²„í¼ í¬ê¸° í…ŒìŠ¤íŠ¸
for bufsize in 5 10 20 50 100; do
  ./dbsys --join \
    --outer-table data/part.dat \
    --inner-table data/partsupp.dat \
    --outer-type PART \
    --inner-type PARTSUPP \
    --output output/result_buf${bufsize}.dat \
    --buffer-size ${bufsize}
done
```

## ëª…ë ¹ì¤„ ì˜µì…˜

### CSV ë³€í™˜ ì˜µì…˜
- `--convert-csv`: CSV ë³€í™˜ ëª¨ë“œ í™œì„±í™”
- `--csv-file FILE`: ì…ë ¥ CSV íŒŒì¼ ê²½ë¡œ
- `--block-file FILE`: ì¶œë ¥ ë¸”ë¡ íŒŒì¼ ê²½ë¡œ
- `--table-type TYPE`: í…Œì´ë¸” íƒ€ì… (PART ë˜ëŠ” PARTSUPP)
- `--block-size SIZE`: ë¸”ë¡ í¬ê¸° (ë°”ì´íŠ¸, ê¸°ë³¸ê°’: 4096)

### Join ì‹¤í–‰ ì˜µì…˜
- `--join`: Join ì‹¤í–‰ ëª¨ë“œ í™œì„±í™”
- `--outer-table FILE`: Outer í…Œì´ë¸” íŒŒì¼ (ë¸”ë¡ í˜•ì‹)
- `--inner-table FILE`: Inner í…Œì´ë¸” íŒŒì¼ (ë¸”ë¡ í˜•ì‹)
- `--outer-type TYPE`: Outer í…Œì´ë¸” íƒ€ì…
- `--inner-type TYPE`: Inner í…Œì´ë¸” íƒ€ì…
- `--output FILE`: ì¶œë ¥ íŒŒì¼ ê²½ë¡œ
- `--buffer-size NUM`: ë²„í¼ ë¸”ë¡ ê°œìˆ˜ (ê¸°ë³¸ê°’: 10)
- `--block-size SIZE`: ë¸”ë¡ í¬ê¸° (ë°”ì´íŠ¸, ê¸°ë³¸ê°’: 4096)

## êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### 1. ë¸”ë¡ êµ¬ì¡°

ê° ë¸”ë¡ì€ ê³ ì • í¬ê¸°(ê¸°ë³¸ 4KB)ì´ë©°, ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì—¬ëŸ¬ ë ˆì½”ë“œë¥¼ í¬í•¨í•©ë‹ˆë‹¤:

```
[Record 1 Size (4B)][Record 1 Data]
[Record 2 Size (4B)][Record 2 Data]
...
[Record N Size (4B)][Record N Data]
[Unused Space]
```

### 2. ë ˆì½”ë“œ ì§ë ¬í™” í˜•ì‹

ê°€ë³€ ê¸¸ì´ ë ˆì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì§ë ¬í™”ë©ë‹ˆë‹¤:

```
[Field 1 Length (2B)][Field 1 Data]
[Field 2 Length (2B)][Field 2 Data]
...
[Field N Length (2B)][Field N Data]
```

### 3. Block Nested Loops Join ì•Œê³ ë¦¬ì¦˜

```cpp
// ì˜ì‚¬ ì½”ë“œ
for each set of (buffer_size - 1) blocks from outer table:
    load blocks into buffer
    for each block from inner table:
        load block into buffer
        for each record r in outer blocks:
            for each record s in inner block:
                if r.partkey == s.partkey:
                    output <r, s> to result
```

**ì‹œê°„ ë³µì¡ë„**: O((|R| / (B-1)) * |S|)
- |R|: Outer í…Œì´ë¸” ë¸”ë¡ ìˆ˜
- |S|: Inner í…Œì´ë¸” ë¸”ë¡ ìˆ˜
- B: ë²„í¼ í¬ê¸° (ë¸”ë¡ ê°œìˆ˜)

**I/O ë³µì¡ë„**: |R| + (|R| / (B-1)) * |S|

### 4. ë²„í¼ ê´€ë¦¬

- **ì´ ë²„í¼**: Bê°œì˜ ë¸”ë¡
- **Outer í…Œì´ë¸”ìš©**: B-1 ê°œì˜ ë¸”ë¡
- **Inner í…Œì´ë¸”ìš©**: 1ê°œì˜ ë¸”ë¡
- **ì¶œë ¥ìš©**: ë³„ë„ 1ê°œì˜ ë¸”ë¡ (ë©”ëª¨ë¦¬ì—ì„œ ê´€ë¦¬)

## ì„±ëŠ¥ ë¶„ì„

í”„ë¡œê·¸ë¨ì€ ì‹¤í–‰ í›„ ë‹¤ìŒê³¼ ê°™ì€ í†µê³„ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤:

```
=== Join Statistics ===
Block Reads: 12345
Block Writes: 567
Output Records: 98765
Elapsed Time: 1.234 seconds
Memory Usage: 40960 bytes (0.039 MB)
```

### ì„±ëŠ¥ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ìš”ì†Œ

1. **ë²„í¼ í¬ê¸°**:
   - ë²„í¼ê°€ í´ìˆ˜ë¡ Inner í…Œì´ë¸” ìŠ¤ìº” íšŸìˆ˜ ê°ì†Œ
   - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€

2. **ë¸”ë¡ í¬ê¸°**:
   - í° ë¸”ë¡: I/O íšŸìˆ˜ ê°ì†Œ, ë ˆì½”ë“œ ì²˜ë¦¬ ì˜¤ë²„í—¤ë“œ ì¦ê°€
   - ì‘ì€ ë¸”ë¡: I/O íšŸìˆ˜ ì¦ê°€, ë ˆì½”ë“œ ì²˜ë¦¬ íš¨ìœ¨ì 

3. **í…Œì´ë¸” í¬ê¸°**:
   - ì‘ì€ í…Œì´ë¸”ì„ Outerë¡œ ì„ íƒí•˜ë©´ ì„±ëŠ¥ í–¥ìƒ

## í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±

TPC-H ë²¤ì¹˜ë§ˆí¬ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```bash
# TPC-H ë„êµ¬ ë‹¤ìš´ë¡œë“œ ë° ì»´íŒŒì¼
git clone https://github.com/electrum/tpch-dbgen.git
cd tpch-dbgen
make

# Scale Factor 0.1 (ì•½ 100MB ë°ì´í„°) ìƒì„±
./dbgen -s 0.1

# ìƒì„±ëœ .tbl íŒŒì¼ì„ data/ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
cp part.tbl partsupp.tbl ../DBSys/data/
```

ë˜ëŠ” ìƒ˜í”Œ ë°ì´í„° ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©:

```bash
# ì†Œê·œëª¨ ìƒ˜í”Œ ë°ì´í„° ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
./scripts/generate_sample_data.sh
```

## ìµœì í™” ê¸°ë²•

í˜„ì¬ êµ¬í˜„ëœ ìµœì í™”:
- âœ… ë©€í‹° ë¸”ë¡ ë²„í¼ë§
- âœ… íš¨ìœ¨ì ì¸ ë©”ëª¨ë¦¬ ê´€ë¦¬ (ì´ë™ ì‹œë§¨í‹±)
- âœ… ë¸”ë¡ ë‹¨ìœ„ I/O

ì¶”ê°€ ìµœì í™” ê°€ëŠ¥ í•­ëª©:
- ğŸ”„ í•´ì‹œ ì¡°ì¸ìœ¼ë¡œ í™•ì¥
- ğŸ”„ ë³‘ë ¬ ì²˜ë¦¬ (ë©€í‹°ìŠ¤ë ˆë”©)
- ğŸ”„ ì¸ë±ìŠ¤ ê¸°ë°˜ ì¡°ì¸
- ğŸ”„ SIMD ìµœì í™”

## ë³´ê³ ì„œ ì‘ì„± ê°€ì´ë“œ

### í¬í•¨í•´ì•¼ í•  ë‚´ìš©

1. **êµ¬í˜„ ì„¸ë¶€ì‚¬í•­**
   - ë¸”ë¡ ë° ë ˆì½”ë“œ ê´€ë¦¬ ë°©ì‹
   - Join ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
   - ë²„í¼ ê´€ë¦¬ ì „ëµ

2. **ì„±ëŠ¥ ë¶„ì„**
   - ë‹¤ì–‘í•œ ë²„í¼ í¬ê¸°ì— ë”°ë¥¸ ì„±ëŠ¥ ë¹„êµ
   - ìˆ˜í–‰ ì‹œê°„, I/O íšŸìˆ˜, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¸¡ì •
   - ê·¸ë˜í”„ ë° í‘œë¡œ ì‹œê°í™”

3. **ì„±ëŠ¥ ì¸¡ì • ì˜ˆì‹œ**
   ```bash
   # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²°ê³¼ ì €ì¥
   ./scripts/benchmark.sh > performance_results.txt
   ```

4. **ìµœì í™” ì „ëµ**
   - ì ìš©í•œ ìµœì í™” ê¸°ë²• ì„¤ëª…
   - ì„±ëŠ¥ ê°œì„  íš¨ê³¼ ë¶„ì„

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì»´íŒŒì¼ ì—ëŸ¬
```bash
# C++11 í‘œì¤€ í™•ì¸
g++ --version

# ëª…ì‹œì ìœ¼ë¡œ C++11 í‘œì¤€ ì§€ì •
make CXXFLAGS="-std=c++11 -Iinclude"
```

### ë©”ëª¨ë¦¬ ë¶€ì¡± ì—ëŸ¬
- ë²„í¼ í¬ê¸°ë¥¼ ì¤„ì´ì„¸ìš”: `--buffer-size 5`
- ë¸”ë¡ í¬ê¸°ë¥¼ ì¤„ì´ì„¸ìš”: `--block-size 2048`

### ì˜ëª»ëœ ë°ì´í„° í˜•ì‹
- CSV íŒŒì¼ì´ íŒŒì´í”„(|) êµ¬ë¶„ìë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸
- íŒŒì¼ ì¸ì½”ë”©ì´ UTF-8ì¸ì§€ í™•ì¸

## ë¼ì´ì„ ìŠ¤

Educational purposes only.

## ì°¸ê³  ìë£Œ

- [TPC-H Benchmark](http://www.tpc.org/tpch/)
- Database System Concepts (Silberschatz, Korth, Sudarshan)
- [Block Nested Loops Join](https://en.wikipedia.org/wiki/Nested_loop_join#Block_nested_loop)

## ì €ì

Database Systems Course Project
